<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="JavaScript 内存管理"/><meta name="keywords" content="陈鑫谱,xinpu,昕浦,xinpuchen,前端,frontend-notes,awesome-coding" /><link rel="alternate" href="/atom.xml" title="Xinpu's Blog"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=2.11.0" />
<link rel="canonical" href="https://xinpuchen.github.io/js-memory-management/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" /><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":true};
</script>

    <title>JavaScript 内存管理 - Xinpu's Blog</title>
  <meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Xinpu's Blog" type="application/atom+xml">
</head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Xinpu's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签
          </li>
      </a><a href="https://xinpuchen.top/frontend-notes/" target="_blank" rel="noopener">
        <li class="mobile-menu-item">前端笔记
          </li>
      </a><a href="https://xinpuchen.top/awesome-coding/" target="_blank" rel="noopener">
        <li class="mobile-menu-item">算法练习
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Xinpu's Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            分类
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            标签
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="https://xinpuchen.top/frontend-notes/" target="_blank" rel="noopener">
            前端笔记
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="https://xinpuchen.top/awesome-coding/" target="_blank" rel="noopener">
            算法练习
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            关于
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">JavaScript 内存管理
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-03-17
        </span><span class="post-category">
            <a href="/categories/Browser/">Browser</a>
            <a href="/categories/Browser/JavaScript/">JavaScript</a>
            </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是内存泄漏？"><span class="toc-text">什么是内存泄漏？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存的占用"><span class="toc-text">内存的占用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存的分配"><span class="toc-text">内存的分配</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存的回收"><span class="toc-text">内存的回收</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#导致内存泄漏的原因"><span class="toc-text">导致内存泄漏的原因</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#没有完全切断与-GC-root-之间的路径"><span class="toc-text">没有完全切断与 GC root 之间的路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#过度占用了内存空间"><span class="toc-text">过度占用了内存空间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文献"><span class="toc-text">参考文献</span></a></li></ol>
    </div>
  </div><div class="post-content"><h2 id="什么是内存泄漏？"><a href="#什么是内存泄漏？" class="headerlink" title="什么是内存泄漏？"></a>什么是内存泄漏？</h2><p><img src="/images/js-memory-management-5.png" alt=""></p>
<p>当我们决定不再使用某些内存时，由于错误的编码，未能使得 GC(Garbage Collection)正确的将这些内存回收的情况，就是内存泄漏。</p>
<a id="more"></a>

<h2 id="内存的占用"><a href="#内存的占用" class="headerlink" title="内存的占用"></a>内存的占用</h2><p>一个对象占用的内存分为直接占用内存(Shallow Size)和占用总内存(Retained Size)，赋值和 New 操作都会涉及到内存的占用。</p>
<ul>
<li>直接占用内存：对象本身占用的内存。典型的 JavaScript 对象都会有保留内存用来描述这个对象和存储它的直接值。一般，只有数组和字符串会有明显的直接占用内存(Shallow Size)。但字符串和数组常常会在渲染器内存中存储主要数据部分，仅仅在 JavaScript 对象栈中暴露一个很小的包装对象。</li>
<li>占用总内存：直接占用内存和这个引用的依赖对象所占用的内存。</li>
</ul>
<h2 id="内存的分配"><a href="#内存的分配" class="headerlink" title="内存的分配"></a>内存的分配</h2><p>Chrome V8 的垃圾回收（GC）算法基于 Generational Collection，内存被划分为两种，分别称为 Young Generation（YG）和 Old Generation（OG）。</p>
<blockquote>
<p>所谓 Young 和 Old 是根据他们占用的时间来划分的。内存在 YG 的分配和回收快而频繁，一般存在的时间很短，所以称为 Young；而在 OG 中则慢而少发生，所以称为 Old。</p>
</blockquote>
<p>因为在 V8 中，YG 的 GC 过程会阻塞程序，而 OG 的 GC 不会阻塞。所以通常情况下开发者更关心 YG 的细节。</p>
<p>YG 又被平分为两部分空间，分别称为 From 和 To。所有内存从 To 空间被分配出去，当 To 满时，开始触发 GC，接下来细看一下。</p>
<p>某时刻，To 已经分 A、B 和 C 分配了内存，当前它剩下一小块内存未分配出去，而 From 所有的内存都空闲着。</p>
<p><img src="/images/js-memory-management-1.png" alt=""></p>
<p>此时，一个程序需要为 D 分配内存，但 D 需要的内存大小超出了 To 未分配的内存，如下图。此时，触发 GC，页面停止执行。</p>
<p><img src="/images/js-memory-management-2.png" alt=""></p>
<p>接着 From 和 To 进行对换，即原来的 To 空间被标志为 From，From 被标志为 To。并且把活的变量值（例如 B）标志出来，而”垃圾“（例如 AC）未被标志，它们将会被清掉。</p>
<p><img src="/images/js-memory-management-3.png" alt=""></p>
<p>活的 B 会被复制到 To 空间，而「垃圾」AC 则被回收，同时，D 被分配到 To 空间，最后成下图的分布</p>
<p><img src="/images/js-memory-management-4.png" alt=""></p>
<p>至此，整个 GC 完成，此过程中页面停止执行，所以要尽可能的快。当 YG 中的值存活比较久时，它会被推向 OG，OG 的空间满时，触发 OG 内的 GC，OG 的 GC 时会触发 YG 的 GC。</p>
<ul>
<li>每次分配都使 To 的可用空间减小，程序又更接近 GC</li>
<li>YG 的 GC 会阻塞程序，所以 GC 时间不宜太长 10ms 以内，因为 16ms 就会出现丢帧；GC 不宜太频繁</li>
<li>某个值变成垃圾后，不会立马释放内存，只有在 GC 的时候所占内存才会被回收。</li>
</ul>
<h2 id="内存的回收"><a href="#内存的回收" class="headerlink" title="内存的回收"></a>内存的回收</h2><p>GC Root 是内存的根结节，在浏览器中它是 window，在 NodeJS 中则是 global 对象。</p>
<p><img src="/images/js-memory-management-5.png" alt=""></p>
<p>从 GC Root 开始遍历图，所有能到达的节点称为活节点，如果存在 GC Root 不能到达的节点，那么该节点称为“垃圾”，将会被回收，如图中灰色的节点。</p>
<p>至于根节点的回收，不受用户的控制。</p>
<h2 id="导致内存泄漏的原因"><a href="#导致内存泄漏的原因" class="headerlink" title="导致内存泄漏的原因"></a>导致内存泄漏的原因</h2><h3 id="没有完全切断与-GC-root-之间的路径"><a href="#没有完全切断与-GC-root-之间的路径" class="headerlink" title="没有完全切断与 GC root 之间的路径"></a>没有完全切断与 GC root 之间的路径</h3><p>因为没有完全切断与根节点之间的路径，导致自动 GC 不会回收这部分内存，从而造成内存泄漏。</p>
<ul>
<li><p>对象之间的相互引用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a, b;</span><br><span class="line">a.reference = b;</span><br><span class="line">b.reference = a;</span><br></pre></td></tr></table></figure></li>
<li><p>错误使用了全局变量</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">a = <span class="string">"1234567"</span>;</span><br><span class="line">相当于;</span><br><span class="line"><span class="built_in">window</span>.a = <span class="string">"1234567"</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>DOM 元素清空或删除时，绑定的事件未清除</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"myDiv"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"Click me"</span> <span class="attr">id</span>=<span class="string">"myBtn"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">"myBtn"</span>);</span></span><br><span class="line"><span class="actionscript">  btn.onclick = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"myDiv"</span>).innerHTML = <span class="string">"Processing..."</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">/* 清除事件绑定 */</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// btn.onclick = null;</span></span></span><br><span class="line">  &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>闭包引用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindEvent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> obj = <span class="built_in">document</span>.getElementById(<span class="string">"xxx"</span>);</span><br><span class="line"></span><br><span class="line">  obj.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/** 空函数*/</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** delete this reference */</span></span><br><span class="line">  <span class="comment">// obj = null;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DOM 元素清空或删除时，子元素存在 JS 引用，导致子元素的所有父元素都不会被删除</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// b是a的子dom节点, a是body的子节点</span></span><br><span class="line"><span class="keyword">var</span> aElement = <span class="built_in">document</span>.getElementById(<span class="string">"a"</span>);</span><br><span class="line"><span class="keyword">var</span> bElement = <span class="built_in">document</span>.getElementById(<span class="string">"b"</span>);</span><br><span class="line"><span class="built_in">document</span>.body.removeChild(aElement);</span><br><span class="line"><span class="comment">// aElement = null；</span></span><br><span class="line"><span class="comment">// bElement = null;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="过度占用了内存空间"><a href="#过度占用了内存空间" class="headerlink" title="过度占用了内存空间"></a>过度占用了内存空间</h3><p>更多的出现在 nodejs 中，例如：</p>
<ul>
<li>无节制的循环<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// do sth</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>过大的数组<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000000000</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = &#123;</span><br><span class="line">    desc: <span class="string">"an object"</span></span><br><span class="line">  &#125;;</span><br><span class="line">  arr.push(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="http://www.codeceo.com/article/chrome-javascript-memory.html" target="_blank" rel="noopener">《Chrome 开发者工具之 JavaScript 内存分析》</a></p>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://xinpuchen.github.io">昕浦</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://xinpuchen.github.io/js-memory-management/">https://xinpuchen.github.io/js-memory-management/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/JavaScript/">JavaScript</a>
            <a href="/tags/Web-Development/">Web Development</a>
            <a href="/tags/Storage/">Storage</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/how-to-fetch-data-with-react-hooks/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">如何使用 React Hooks 获取数据？</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/overrides-mode/">
        <span class="next-text nav-default">覆盖模式-提高 React 组件的复用率</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"><div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:xinpuchen@foxmail.com" class="iconfont icon-email" title="email"></a>
        <a href="https://www.linkedin.com/in/xinpuchen" target="_blank" rel="noopener" class="iconfont icon-linkedin" title="linkedin"></a>
        <a href="https://github.com/xinpuchen" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">Even</a>
  </span>

  <span class="copyright-year">&copy;2018 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">昕浦</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://xinpuchen.github.io/js-memory-management/';
        this.page.identifier = 'js-memory-management/';
        this.page.title = 'JavaScript 内存管理';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//xinpuchen.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"/>


<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: 'GitHub Application Client ID',
    clientSecret: 'GitHub Application Client Secret',
    repo: 'GitHub repo',
    owner: 'GitHub repo owner',
    admin: ['GitHub repo owner and collaborators, only these guys can initialize github issues'],
    id: md5(location.pathname),
    
      language: 'zh-CN',
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
